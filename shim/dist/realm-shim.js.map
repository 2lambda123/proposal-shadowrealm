{"version":3,"file":"realm-shim.js","sources":["../src/sanitize.js","../src/proxy.js","../src/evaluate.js","../src/evaluators.js","../src/sandbox.js","../src/intrinsics.js","../src/stdlib.js","../src/utils.js","../src/realm.js"],"sourcesContent":["// locking down the environment\nexport function sanitize(sandbox) {\n    const { confinedWindow: { Object: o } } = sandbox;\n    try {\n        // Fixing properties of Object to comply with strict mode\n        // and ES2016 semantics, we do this by redefining them while in 'use strict'\n        // https://tc39.github.io/ecma262/#sec-object.prototype.__defineGetter__\n        if (o === undefined) {\n            return;\n        }\n        o.defineProperty(o.prototype, '__defineGetter__', {\n            value: function (key, fn) {\n                return o.defineProperty(this, key, {\n                    get: fn\n                });\n            }\n        });\n        o.defineProperty(o.prototype, '__defineSetter__', {\n            value: function (key, fn) {\n                return o.defineProperty(this, key, {\n                    set: fn\n                });\n            }\n        });\n        o.defineProperty(o.prototype, '__lookupGetter__', {\n            value: function (key) {\n                var d, p = this;\n                while (p && (d = o.getOwnPropertyDescriptor(p, key)) === undefined) {\n                    p = o.getPrototypeOf(this);\n                }\n                return d ? d.get : undefined;\n            }\n        });\n        o.defineProperty(o.prototype, '__lookupSetter__', {\n            value: function (key) {\n                var d, p = this;\n                while (p && (d = o.getOwnPropertyDescriptor(p, key)) === undefined) {\n                    p = o.getPrototypeOf(this);\n                }\n                return d ? d.set : undefined;\n            }\n        });\n        // Immutable Prototype Exotic Objects\n        // https://github.com/tc39/ecma262/issues/272\n        o.seal(o.prototype);\n    } catch (ignore) {\n        // Ignored\n    }\n}","// this flag allow us to determine if the eval() call is a controlled eval done by the realm's code\n// or if it is user-land invocation, so we can react differently.\nlet isInternalEvaluation = false;\n\nexport function setInternalEvaluation() {\n    isInternalEvaluation = true;\n}\n\nexport function resetInternalEvaluation() {\n    isInternalEvaluation = false;\n}\n\nexport const proxyHandler = {\n    get(sandbox, propName) {\n        if (propName === 'eval' && isInternalEvaluation) {\n            resetInternalEvaluation();\n            return sandbox.confinedWindow.eval;\n        }\n        return sandbox.globalObject[propName];\n    },\n    set(sandbox, propName, newValue) {\n        sandbox.globalObject[propName] = newValue;\n        return true;\n    },\n    defineProperty(sandbox, propName, descriptor) {\n        Object.defineProperty(sandbox.globalObject, propName, descriptor);\n        return true;\n    },\n    deleteProperty(sandbox, propName) {\n        return Reflect.deleteProperty(sandbox.globalObject, propName);\n    },\n    has(sandbox, propName) {\n        if (propName === 'eval' && isInternalEvaluation) {\n            return true;\n        }\n        if (propName in sandbox.globalObject) {\n            return true;\n        } else if (propName in sandbox.confinedWindow) {\n            throw new ReferenceError(`${propName} is not defined. If you are using typeof ${propName}, you can change your program to use typeof global.${propName} instead`);\n        }\n        return false;\n    },\n    ownKeys(sandbox) {\n        return Object.getOwnPropertyNames(sandbox.globalObject);\n    },\n    getOwnPropertyDescriptor(sandbox, propName) {\n        return Object.getOwnPropertyDescriptor(sandbox.globalObject, propName);\n    },\n    isExtensible(sandbox) {\n        // TODO: can it becomes non-extensible?\n        return true;\n    },\n    getPrototypeOf(sandbox) {\n        return null;\n    },\n    setPrototypeOf(sandbox, prototype) {\n        return prototype === null ? true : false;\n    },\n};","import {\n    setInternalEvaluation,\n    resetInternalEvaluation,\n} from \"./proxy\";\n\nconst HookFnName = '$RealmEvaluatorIIFE$';\n\n// Wrapping the source with `with` statement creates a new lexical scope,\n// that can prevent access to the globals in the sandbox by shadowing them\n// via globalProxy.\nfunction addLexicalScopesToSource(sourceText) {\n    /**\n     * We use a `with` statement who uses `argments[0]`, which is the\n     * `sandbox.globalProxy` that implements the shadowing mechanism as well as access to\n     * any global variable.\n     * Aside from that, the `this` value in sourceText will correspond to `sandbox.thisValue`.\n     * We have to use `arguments` instead of naming them to avoid name collision.\n     */\n    // escaping backsticks to prevent leaking the original eval as well as syntax errors\n    sourceText = sourceText.replace(/\\`/g, '\\\\`');\n    return `\n        function ${HookFnName}() {\n            with(arguments[0]) {\n                return (function(){\n                    \"use strict\";\n                    return eval(\\`${sourceText}\\`);\n                }).call(this);\n            }\n        }\n    `;\n}\n\nfunction evalAndReturn(sourceText, sandbox) {\n    const { iframeDocument, confinedWindow } = sandbox;\n    const { body: iframeBody } = iframeDocument;\n    const script = iframeDocument.createElement('script');\n    script.type = 'text/javascript';\n    confinedWindow[HookFnName] = undefined;\n    script.appendChild(iframeDocument.createTextNode(sourceText));\n    iframeBody.appendChild(script);\n    iframeBody.removeChild(script);\n    const result = confinedWindow[HookFnName];\n    confinedWindow[HookFnName] = undefined;\n    return result;\n}\n\nexport function evaluate(sourceText, sandbox) {\n    if (!sourceText) {\n        return undefined;\n    }\n    sourceText = addLexicalScopesToSource(sourceText + '');\n    setInternalEvaluation();\n    const fn = evalAndReturn(sourceText, sandbox);\n    const result = fn.apply(sandbox.thisValue, [sandbox.globalProxy]);\n    resetInternalEvaluation();\n    return result;\n}","import { evaluate } from \"./evaluate\";\n\nfunction getEvalEvaluator(sandbox) {\n    const o = {\n        // trick to set the name of the function to \"eval\"\n        eval: function(sourceText) {\n            // console.log(`Shim-Evaluation: \"${sourceText}\"`);\n            return evaluate(sourceText, sandbox);\n        }\n    };\n    Object.setPrototypeOf(o.eval, sandbox.Function);\n    o.eval.toString = () => 'function eval() { [shim code] }';\n    return o.eval;\n}\n\nfunction getFunctionEvaluator(sandbox) {\n    const { confinedWindow } = sandbox;\n    const f = function Function(...args) {\n        // console.log(`Shim-Evaluation: Function(\"${args.join('\", \"')}\")`);\n        const sourceText = args.pop();\n        const fnArgs = args.join(', ');\n        return evaluate(`(function anonymous(${fnArgs}){\\n${sourceText}\\n}).bind(this)`, sandbox);\n    }\n    f.prototype = confinedWindow.Function.prototype;\n    Object.setPrototypeOf(f, f.prototype);\n    f.prototype.constructor = f;\n    f.toString = () => 'function Function() { [shim code] }';\n    return f;\n}\n\nexport function getEvaluators(sandbox) {\n    sandbox.Function = getFunctionEvaluator(sandbox);\n    sandbox.eval = getEvalEvaluator(sandbox);\n}","import { sanitize } from \"./sanitize\";\nimport { getEvaluators } from \"./evaluators\";\nimport { proxyHandler } from \"./proxy\";\n\nfunction createIframe() {\n    const el = document.createElement(\"iframe\");\n    el.style.display = \"none\";\n    // accessibility\n    el.title = \"script\";\n    el.setAttribute('aria-hidden', true);\n    document.body.appendChild(el);\n    return el;\n}\n\nexport function createSandbox() {\n    const iframe = createIframe();\n    const { contentDocument: iframeDocument, contentWindow: confinedWindow } = iframe;\n    const sandbox = {\n        iframe,\n        iframeDocument,\n        confinedWindow,\n        thisValue: undefined,\n        globalObject: undefined,\n        globalProxy: undefined,\n    };\n    sanitize(sandbox);\n    Object.assign(sandbox, getEvaluators(sandbox));\n    sandbox.globalProxy = new Proxy(sandbox, proxyHandler);\n    return sandbox;\n}\n\nexport function setSandboxGlobalObject(sandbox, globalObject, thisValue) {\n    sandbox.thisValue = thisValue;\n    sandbox.globalObject = globalObject;\n}","import Realm from \"./realm\";\n\nconst getProto = Object.getPrototypeOf;\nconst iteratorSymbol = (typeof Symbol && Symbol.iterator) || \"@@iterator\";\n\nexport function getIntrinsics(sandbox) {\n    const { confinedWindow: _ } = sandbox;\n    const anonymousArrayIteratorPrototype = getProto(_.Array(0)[iteratorSymbol]());\n    const anonymousStringIteratorPrototype = getProto(_.String()[iteratorSymbol]());\n    const anonymousIteratorPrototype = getProto(anonymousArrayIteratorPrototype);\n\n    const strictArgumentsGenerator = _.eval('(function*(){\"use strict\";yield arguments;})');\n    const anonymousGenerator = getProto(strictArgumentsGenerator);\n    const anonymousGeneratorPrototype = getProto(anonymousGenerator);\n    const anonymousGeneratorFunction = anonymousGeneratorPrototype.constructor;\n\n    return {\n        // %Array%\n        \"Array\": _.Array,\n        // %ArrayBuffer%\n        \"ArrayBuffer\": _.ArrayBuffer,\n        // %ArrayBufferPrototype%\n        \"ArrayBufferPrototype\": _.ArrayBuffer.prototype,\n        // %ArrayIteratorPrototype%\n        \"ArrayIteratorPrototype\": anonymousArrayIteratorPrototype,\n        // %ArrayPrototype%\n        \"ArrayPrototype\": _.Array.prototype,\n        // %ArrayProto_values%\n        \"ArrayProto_values\": _.Array.prototype.values,\n        // %Boolean%\n        \"Boolean\": _.Boolean,\n        // %BooleanPrototype%\n        \"BooleanPrototype\": _.Boolean.prototype,\n        // %DataView%\n        \"DataView\": _.DataView,\n        // %DataViewPrototype%\n        \"DataViewPrototype\": _.DataView.prototype,\n        // %Date%\n        \"Date\": _.Date,\n        // %DatePrototype%\n        \"DatePrototype\": _.Date.prototype,\n        // %decodeURI%\n        \"decodeURI\": _.decodeURI,\n        // %decodeURIComponent%\n        \"decodeURIComponent\": _.decodeURIComponent,\n        // %encodeURI%\n        \"encodeURI\": _.encodeURI,\n        // %encodeURIComponent%\n        \"encodeURIComponent\": _.encodeURIComponent,\n        // %Error%\n        \"Error\": _.Error,\n        // %ErrorPrototype%\n        \"ErrorPrototype\": _.Error.prototype,\n        // %eval%\n        \"eval\": sandbox.eval,\n        // %EvalError%\n        \"EvalError\": _.EvalError,\n        // %EvalErrorPrototype%\n        \"EvalErrorPrototype\": _.EvalError.prototype,\n        // %Float32Array%\n        \"Float32Array\": _.Float32Array,\n        // %Float32ArrayPrototype%\n        \"Float32ArrayPrototype\": _.Float32Array.prototype,\n        // %Float64Array%\n        \"Float64Array\": _.Float64Array,\n        // %Float64ArrayPrototype%\n        \"Float64ArrayPrototype\": _.Float64Array.prototype,\n        // %Function%\n        \"Function\": sandbox.Function,\n        // %FunctionPrototype%\n        \"FunctionPrototype\": _.Function.prototype,\n        // %Generator%\n        \"Generator\": anonymousGenerator,\n        // %GeneratorFunction%\n        \"GeneratorFunction\": anonymousGeneratorFunction,\n        // %GeneratorPrototype%\n        \"GeneratorPrototype\": anonymousGeneratorPrototype,\n        // %Int8Array%\n        \"Int8Array\": _.Int8Array,\n        // %Int8ArrayPrototype%\n        \"Int8ArrayPrototype\": _.Int8Array.prototype,\n        // %Int16Array%\n        \"Int16Array\": _.Int16Array,\n        // %Int16ArrayPrototype%,\n        \"Int16ArrayPrototype\": _.Int16Array.prototype,\n        // %Int32Array%\n        \"Int32Array\": _.Int32Array,\n        // %Int32ArrayPrototype%\n        \"Int32ArrayPrototype\": _.Int32Array.prototype,\n        // %isFinite%\n        \"isFinite\": _.isFinite,\n        // %isNaN%\n        \"isNaN\": _.isNaN,\n        // %IteratorPrototype%\n        \"IteratorPrototype\": anonymousIteratorPrototype,\n        // %JSON%\n        \"JSON\": _.JSON,\n        // %Map%\n        \"Map\": _.Map,\n        // %MapIteratorPrototype%\n        \"MapIteratorPrototype\": undefined,\n        // %MapPrototype%\n        \"MapPrototype\": _.Map.prototype,\n        // %Math%\n        \"Math\": _.Math,\n        // %Number%\n        \"Number\": _.Number,\n        // %NumberPrototype%\n        \"NumberPrototype\": _.Number.prototype,\n        // %Object%\n        \"Object\": _.Object,\n        // %ObjectPrototype%\n        \"ObjectPrototype\": _.Object.prototype,\n        // %ObjProto_toString%\n        \"ObjProto_toString\": _.Object.prototype.toString,\n        // %ObjProto_valueOf%\n        \"ObjProto_valueOf\": _.Object.prototype.valueOf,\n        // %parseFloat%\n        \"parseFloat\": _.parseFloat,\n        // %parseInt%\n        \"parseInt\": _.parseInt,\n        // %Promise%\n        \"Promise\": _.Promise,\n        // %PromisePrototype%\n        \"PromisePrototype\": _.Promise.prototype,\n        // %Proxy%\n        \"Proxy\": _.Proxy,\n        // %RangeError%\n        \"RangeError\": _.RangeError,\n        // %RangeErrorPrototype%\n        \"RangeErrorPrototype\": _.RangeError.prototype,\n        // %ReferenceError%\n        \"ReferenceError\": _.ReferenceError,\n        // %ReferenceErrorPrototype%\n        \"ReferenceErrorPrototype\": _.ReferenceError.prototype,\n        // %Reflect%\n        \"Reflect\": _.Reflect,\n        // %RegExp%\n        \"RegExp\": _.RegExp,\n        // %RegExpPrototype%\n        \"RegExpPrototype\": _.RegExp.prototype,\n        // %Set%\n        \"Set\": _.Set,\n        // %SetIteratorPrototype%\n        \"SetIteratorPrototype\": undefined,\n        // %SetPrototype%\n        \"SetPrototype\": _.Set.prototype,\n        // %String%\n        \"String\": _.String,\n        // %StringIteratorPrototype%\n        \"StringIteratorPrototype\": anonymousStringIteratorPrototype,\n        // %StringPrototype%\n        \"StringPrototype\": _.String.prototype,\n        // %Symbol%\n        \"Symbol\": _.Symbol,\n        // %SymbolPrototype%\n        \"SymbolPrototype\": _.Symbol.prototype,\n        // %SyntaxError%\n        \"SyntaxError\": _.SyntaxError,\n        // %SyntaxErrorPrototype%\n        \"SyntaxErrorPrototype\": _.SyntaxError.prototype,\n        // %ThrowTypeError%\n        \"ThrowTypeError\": undefined,\n        // %TypedArray%\n        \"TypedArray\": undefined,\n        // %TypedArrayPrototype%\n        \"TypedArrayPrototype\": undefined,\n        // %TypeError%\n        \"TypeError\": _.TypeError,\n        // %TypeErrorPrototype%\n        \"TypeErrorPrototype\": _.TypeError.prototype,\n        // %Uint8Array%\n        \"Uint8Array\": _.Uint8Array,\n        // %Uint8ArrayPrototype%\n        \"Uint8ArrayPrototype\": _.Uint8Array.prototype,\n        // %Uint8ClampedArray%\n        \"Uint8ClampedArray\": _.Uint8ClampedArray,\n        // %Uint8ClampedArrayPrototype%\n        \"Uint8ClampedArrayPrototype\": _.Uint8ClampedArray.prototype,\n        // %Uint16Array%\n        \"Uint16Array\": _.Uint16Array,\n        // %Uint16ArrayPrototype%\n        \"Uint16ArrayPrototype\": Uint16Array.prototype,\n        // %Uint32Array%\n        \"Uint32Array\": _.Uint32Array,\n        // %Uint32ArrayPrototype%\n        \"Uint32ArrayPrototype\": _.Uint32Array.prototype,\n        // %URIError%\n        \"URIError\": _.URIError,\n        // %URIErrorPrototype%\n        \"URIErrorPrototype\": _.URIError.prototype,\n        // %WeakMap%\n        \"WeakMap\": _.WeakMap,\n        // %WeakMapPrototype%\n        \"WeakMapPrototype\": _.WeakMap.prototype,\n        // %WeakSet%\n        \"WeakSet\": _.WeakSet,\n        // %WeakSetPrototype%\n        \"WeakSetPrototype\": _.WeakSet.prototype,\n\n        // TODO: Annex B\n        // TODO: other special cases\n\n        // ESNext\n        Realm, // intentionally passing around the Realm Constructor, which could be used as a side channel, but still!\n    };\n}","import { getIntrinsics } from \"./intrinsics\";\n\nexport function getStdLib(sandbox) {\n    const intrinsics = getIntrinsics(sandbox);\n    return {\n        Array: { value: intrinsics.Array },\n        ArrayBuffer: { value: intrinsics.ArrayBuffer },\n        Boolean: { value: intrinsics.Boolean },\n        DataView: { value: intrinsics.DataView },\n        Date: { value: intrinsics.Date },\n        decodeURI: { value: intrinsics.decodeURI },\n        decodeURIComponent: { value: intrinsics.decodeURIComponent },\n        encodeURI: { value: intrinsics.encodeURI },\n        encodeURIComponent: { value: intrinsics.encodeURIComponent },\n        Error: { value: intrinsics.Error },\n        eval: { value: intrinsics.eval },\n        EvalError: { value: intrinsics.EvalError },\n        Float32Array: { value: intrinsics.Float32Array },\n        Float64Array: { value: intrinsics.Float64Array },\n        Function: { value: intrinsics.Function },\n        Int8Array: { value: intrinsics.Int8Array },\n        Int16Array: { value: intrinsics.Int16Array },\n        Int32Array: { value: intrinsics.Int32Array },\n        isFinite: { value: intrinsics.isFinite },\n        isNaN: { value: intrinsics.isNaN },\n        JSON: { value: intrinsics.JSON },\n        Map: { value: intrinsics.Map },\n        Math: { value: intrinsics.Math },\n        Number: { value: intrinsics.Number },\n        Object: { value: intrinsics.Object },\n        parseFloat: { value: intrinsics.parseFloat },\n        parseInt: { value: intrinsics.parseInt },\n        Promise: { value: intrinsics.Promise },\n        Proxy: { value: intrinsics.Proxy },\n        RangeError: { value: intrinsics.RangeError },\n        ReferenceError: { value: intrinsics.ReferenceError },\n        Reflect: { value: intrinsics.Reflect },\n        RegExp: { value: intrinsics.RegExp },\n        Set: { value: intrinsics.Set },\n        String: { value: intrinsics.String },\n        Symbol: { value: intrinsics.Symbol },\n        SyntaxError: { value: intrinsics.SyntaxError },\n        TypeError: { value: intrinsics.TypeError },\n        Uint8Array: { value: intrinsics.Uint8Array },\n        Uint8ClampedArray: { value: intrinsics.Uint8ClampedArray },\n        Uint16Array: { value: intrinsics.Uint16Array },\n        Uint32Array: { value: intrinsics.Uint32Array },\n        URIError: { value: intrinsics.URIError },\n        WeakMap: { value: intrinsics.WeakMap },\n        WeakSet: { value: intrinsics.WeakSet },\n\n        // TODO: Annex B\n        // TODO: other special cases\n    };\n}","export function assert(condition) {\n    if (!condition) {\n        throw new Error();\n    }\n}\n\nexport function IsCallable(obj) {\n    return typeof obj === 'function';\n}","import { createSandbox, setSandboxGlobalObject } from \"./sandbox\";\nimport { evaluate } from \"./evaluate\";\nimport { getStdLib } from \"./stdlib\";\nimport { getIntrinsics } from \"./intrinsics\";\nimport { assert, IsCallable } from \"./utils\";\n\nconst RealmRecord = Symbol('Realm Slot');\nconst Intrinsics = Symbol('Intrinsics Slot');\nconst GlobalObject = Symbol('GlobalObject Slot');\nconst GlobalThisValue = Symbol('GlobalThisValue Slot');\nconst GlobalEnv = Symbol('GlobalEnv Slot');\nconst EvalHook = Symbol('EvalHook Slot');\nconst IsDirectEvalHook = Symbol('IsDirectEvalHook Slot');\nconst ImportHook = Symbol('ImportHook Slot');\nconst ImportMetaHook = Symbol('ImportMetaHook Slot');\nconst ShimSandbox = Symbol('Sandbox');\n\n// shim specific\nfunction getSandbox(realmRec) {\n    const sandbox = realmRec[ShimSandbox];\n    assert(typeof sandbox === 'object');\n    return sandbox;\n}\n\nfunction getCurrentRealmRecord() {\n    let realmRec = window[RealmRecord];\n    if (!realmRec) {\n        // this is an outer realm, and we should set up the RealmRecord\n        window[RealmRecord] = {\n            // TODO: mimic what the global realm record should have\n            // including default hooks, etc.\n        };\n    }\n    return realmRec;\n}\n\n// <!-- es6num=\"8.1.2.5\" -->\nfunction NewGlobalEnvironment(G, thisValue) {\n    // diverging from spec to accomodate the iframe as the lexical environment\n    // using a class for better debugability\n    class EnvironmentRecord {\n        constructor(/*globalObject*/) {\n            this[GlobalThisValue] = thisValue;\n        }\n    }\n    return new EnvironmentRecord(G);\n}\n\n// <!-- es6num=\"8.2.3\" -->\nfunction SetRealmGlobalObject(realmRec, globalObj, thisValue) {\n    if (globalObj === undefined) {\n        const intrinsics = realmRec[Intrinsics];\n        globalObj = Object.create(intrinsics['ObjectPrototype']);\n    }\n    assert(typeof globalObj === 'object');\n    if (thisValue === undefined) thisValue = globalObj;\n    realmRec[GlobalObject] = globalObj;\n    const newGlobalEnv = NewGlobalEnvironment(globalObj, thisValue);\n    realmRec[GlobalEnv] = newGlobalEnv;\n    return realmRec;\n}\n\n// <!-- es6num=\"8.2.4\" -->\nfunction SetDefaultGlobalBindings(realmRec) {\n    const global = realmRec[GlobalObject];\n    // For each property of the Global Object specified in clause <emu-xref href=\"#sec-global-object\"></emu-xref>, do\n    // ---> diverging:\n    const GlobalObjectDescriptors = getStdLib(realmRec[ShimSandbox]);\n    Object.defineProperties(global, GlobalObjectDescriptors);\n    return global;\n}\n\n// <!-- es6num=\"8.2.2\" -->\nfunction CreateIntrinsics(realmRec) {\n    // ---> diverging\n    let intrinsics = getIntrinsics(realmRec[ShimSandbox]);\n    realmRec[Intrinsics] = intrinsics;\n    return intrinsics;\n}\n\nfunction CreateRealmRec(intrinsics) {\n    let realmRec = /* new Realm Record from table-21 */ {\n        [Intrinsics]: {},\n        [GlobalObject]: undefined,\n        [GlobalEnv]: undefined,\n        // [TemplateMap]: [],\n        // [HostDefined]: undefined,\n        [EvalHook]: undefined,\n        [IsDirectEvalHook]: undefined,\n        [ImportHook]: undefined,\n        [ImportMetaHook]: undefined,\n        // ---> diverging to create the internal shim iframe\n        [ShimSandbox]: createSandbox(),\n    };\n    if (intrinsics === undefined) {\n        CreateIntrinsics(realmRec);\n    } else {\n        // 1. Assert: In this case, _intrinsics_ must be a Record with field names listed in column one of Table 7.\n        realmRec[Intrinsics] = intrinsics;\n    }\n    return realmRec;\n}\n\nfunction InvokeDirectEvalHook(realmRec, x) {\n    // 1. Assert: realm is a Realm Record.\n    const fn = realmRec[EvalHook];\n    if (fn === undefined) return x;\n    assert(IsCallable(fn) === true);\n    return fn.call(undefined, x);\n}\n\n// <!-- es6num=\"18.2.1.1\" -->\nfunction PerformEval(x, evalRealm, strictCaller, direct) {\n    assert(direct === false ? strictCaller === false : true);\n    // realm spec segment begins\n    if (direct === true) {\n        x = InvokeDirectEvalHook(x, evalRealm);\n    }\n    // realm spec segment ends\n    if (typeof x !== 'string') return x;\n    // ---> diverging\n    const sandbox = getSandbox(evalRealm);\n    return evaluate(x, sandbox);\n}\n\nexport default class Realm {\n\n    constructor(options) {\n        const O = this;\n        const parentRealm = getCurrentRealmRecord();\n        const opts = Object(options);\n        let importHook = opts.importHook;\n        if (importHook === \"inherit\") {\n            importHook = parentRealm[ImportHook];\n        } else if (importHook !== undefined && IsCallable(importHook) === false) throw new TypeError();\n        let importMetaHook  = opts.importMetaHook;\n        if (importMetaHook === \"inherit\") {\n            importMetaHook = parentRealm[ImportMetaHook];\n        } else if (importMetaHook !== undefined && IsCallable(importMetaHook) === false) throw new TypeError();\n        let evalHook = opts.evalHook;\n        if (evalHook === \"inherit\") {\n            evalHook = parentRealm[EvalHook];\n        } else if (evalHook !== undefined && IsCallable(evalHook) === false) throw new TypeError();\n        let isDirectEvalHook = opts.isDirectEvalHook;\n        if (isDirectEvalHook === \"inherit\") {\n            isDirectEvalHook = parentRealm[IsDirectEvalHook];\n        } else if (isDirectEvalHook !== undefined && IsCallable(isDirectEvalHook) === false) throw new TypeError();\n        let intrinsics = opts.intrinsics;\n        if (intrinsics === \"inherit\") {\n            intrinsics = parentRealm[Intrinsics];\n        } else if (intrinsics !== undefined) throw new TypeError();\n        let thisValue = opts.thisValue;\n        if (thisValue !== undefined && typeof thisValue !== \"object\") throw new TypeError();\n        const realmRec = CreateRealmRec(intrinsics);\n        O[RealmRecord] = realmRec;\n        SetRealmGlobalObject(realmRec, undefined, thisValue);\n        if (importHook === undefined) {\n            // new built-in function object as defined in <emu-xref href=\"#sec-realm-default-import-hook-functions\"></emu-xref>\n            importHook = function (/*referrer, specifier*/) {\n                throw new TypeError();\n            }\n        }\n        realmRec[ImportHook] = importHook;\n        if (evalHook !== undefined) {\n            realmRec[EvalHook] = evalHook;\n        }\n        if (isDirectEvalHook !== undefined) {\n            realmRec[IsDirectEvalHook] = isDirectEvalHook;\n        }\n        let init = O.init;\n        if (!IsCallable(init)) throw new TypeError();\n        init.call(O);\n        // ---> diverging\n        setSandboxGlobalObject(realmRec[ShimSandbox], realmRec[GlobalObject], realmRec[GlobalEnv][GlobalThisValue]);\n    }\n\n    init() {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        SetDefaultGlobalBindings(O[RealmRecord]);\n    }\n\n    eval(x) {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        let evalRealm = O[RealmRecord];\n        // HostEnsureCanCompileStrings(the current Realm Record, _evalRealm_).\n        return PerformEval(x, evalRealm, false, false);\n    }\n\n    get stdlib() {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        // TODO: align with spec\n        const sandbox = getSandbox(O[RealmRecord]);\n        return getStdLib(sandbox);\n    }\n\n    get intrinsics() {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        // TODO: align with spec\n        const sandbox = getSandbox(O[RealmRecord]);\n        return getIntrinsics(sandbox.confinedWindow);\n    }\n\n    get global() {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        return O[RealmRecord][GlobalObject];\n    }\n\n    get thisValue() {\n        let O = this;\n        if (typeof O !== 'object') throw new TypeError();\n        if (!(RealmRecord in O)) throw new TypeError();\n        let envRec = O[RealmRecord][GlobalEnv];\n        return envRec[GlobalThisValue];\n    }\n\n}\n\nRealm.toString = () => 'function Realm() { [shim code] }';"],"names":["sanitize","sandbox","o","confinedWindow","Object","undefined","defineProperty","prototype","key","fn","d","p","getOwnPropertyDescriptor","getPrototypeOf","get","set","seal","ignore","isInternalEvaluation","setInternalEvaluation","resetInternalEvaluation","proxyHandler","propName","eval","globalObject","newValue","descriptor","Reflect","deleteProperty","ReferenceError","getOwnPropertyNames","HookFnName","addLexicalScopesToSource","sourceText","replace","evalAndReturn","iframeDocument","iframeBody","body","script","createElement","type","appendChild","createTextNode","removeChild","result","evaluate","apply","thisValue","globalProxy","getEvalEvaluator","setPrototypeOf","Function","toString","getFunctionEvaluator","f","args","pop","fnArgs","join","constructor","getEvaluators","createIframe","el","document","style","display","title","setAttribute","createSandbox","iframe","contentDocument","contentWindow","assign","Proxy","setSandboxGlobalObject","getProto","iteratorSymbol","Symbol","iterator","getIntrinsics","_","anonymousArrayIteratorPrototype","Array","anonymousStringIteratorPrototype","String","anonymousIteratorPrototype","strictArgumentsGenerator","anonymousGenerator","anonymousGeneratorPrototype","anonymousGeneratorFunction","ArrayBuffer","values","Boolean","DataView","Date","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Error","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","isFinite","isNaN","JSON","Map","Math","Number","valueOf","parseFloat","parseInt","Promise","RangeError","RegExp","Set","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","getStdLib","intrinsics","value","assert","condition","IsCallable","obj","RealmRecord","Intrinsics","GlobalObject","GlobalThisValue","GlobalEnv","EvalHook","IsDirectEvalHook","ImportHook","ImportMetaHook","ShimSandbox","getSandbox","realmRec","getCurrentRealmRecord","window","NewGlobalEnvironment","G","EnvironmentRecord","SetRealmGlobalObject","globalObj","create","newGlobalEnv","SetDefaultGlobalBindings","global","GlobalObjectDescriptors","defineProperties","CreateIntrinsics","CreateRealmRec","InvokeDirectEvalHook","x","call","PerformEval","evalRealm","strictCaller","direct","Realm","options","O","parentRealm","opts","importHook","importMetaHook","evalHook","isDirectEvalHook","init","envRec"],"mappings":"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"}