(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.Realm=b()})(this,function(){'use strict';function a(a,b){const{unsafeEval:c}=a;return c(B)(b)}function b(a){const b={Infinity:{value:Infinity},NaN:{value:NaN},undefined:{value:void 0}};for(const c of C)b[c]={value:a[c],writable:!0,configurable:!0};return b}function c(){function a(a){return'symbol'==typeof a?a:`${a}`}const{getPrototypeOf:b,defineProperties:c,defineProperty:d,getOwnPropertyDescriptor:e}=Object;c(Object.prototype,{__defineGetter__:{value(a,b){return d(this,a,{get:b,enumerable:!0,configurable:!0})}},__defineSetter__:{value(a,b){return d(this,a,{set:b,enumerable:!0,configurable:!0})}},__lookupGetter__:{value(c){c=a(c);let d,f=this;for(;f&&!(d=e(f,c));)f=b(f);return d&&d.get}},__lookupSetter__:{value(c){c=a(c);let d,f=this;for(;f&&!(d=e(f,c));)f=b(f);return d&&d.set}}})}function d(a,b,c){const{unsafeEval:d,unsafeFunction:e,unsafeGlobal:f}=a;let g;try{g=d(c)}catch(a){if(a instanceof f.SyntaxError)return;throw a}const h=M(g),i=e('throw new Error("Not available");');G(i,{name:{value:b},prototype:{value:h}}),H(h,'constructor',{value:i}),i!==e.prototype.constructor&&N(i,e.prototype.constructor)}function e(a){d(a,'Function','(function(){})'),d(a,'GeneratorFunction','(function*(){})'),d(a,'AsyncFunction','(async function(){})'),d(a,'AsyncGeneratorFunction','(async function*(){})')}function f(a,c){const d=b(a);return I({unsafeGlobal:a,sharedGlobalDescs:d,unsafeEval:a.eval,unsafeFunction:a.Function,allShims:c})}function g(a){e(a)}function h(a){const b=ba(),c=f(b,a);return g(c),c}function i(a){const b=da.exec(a);if(b){const a=b[1].split('\n').length;throw new SyntaxError(`possible import expression rejected around line ${a}`)}}function j(a,b=void 0){const c=`please report internal shim error: ${a}`;console.log(c),b&&(console.log(`${b}`),console.log(`${b.stack}`));debugger;throw c}function k(a,b){a||j(`failed to: ${b}`)}function l(a){const b=[],c=K(a);return R(L(c),(a)=>{const d=c[a];'string'!=typeof a||!W(ea,a)||!1!==d.configurable||!1!==d.writable||'get'in d||'set'in d||S(b,a)}),b}function m(a){return`const {${U(a,',')}} = arguments[0];`}function n(a,b){const{unsafeFunction:c}=a,d=m(b);return c(`
    with (arguments[0]) {
      ${d}
      return function() {
        'use strict';
        return eval(arguments[0]);
      };
    }
  `)}function o(a,b){const{unsafeFunction:c}=a,d=new ca(a),e=F(b),f=new Proxy(e,d),g=l(b),h=n(a,g),m=h(f),o={eval(a){a=`${a}`,i(a),d.useUnsafeEvaluator=!0;let c;try{return O(m,b,[a])}catch(a){throw c=a,a}finally{!1!==d.useUnsafeEvaluator&&(d.useUnsafeEvaluator=!1,j('handler sets useUnsafeEvaluator = false',c))}}}.eval;return N(o,c.prototype),k(M(o).constructor!==Function,'hide Function'),k(M(o).constructor!==c,'hide unsafeFunction'),H(o,'toString',{value:o('() => \'function eval() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),o}function p(a,b){const{unsafeFunction:c,unsafeGlobal:d}=a,e=function(...a){const e=`${T(a)||''}`;let f=`${U(a,',')}`;if(new c(e),X(f,')'))throw new d.SyntaxError('shim limitation: Function arg string contains parenthesis');0<f.length&&(f+='\n/*``*/');const g=`(function(${f}){\n${e}\n})`;return b(g)};return N(e,c.prototype),k(M(e).constructor!==Function,'hide Function'),k(M(e).constructor!==c,'hide unsafeFunction'),H(e,'prototype',{value:c.prototype}),H(e,'toString',{value:b('() => \'function Function() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),e}function q(a){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm constructor');if(!fa.has(a))throw new TypeError('internal error: bad object');return fa.get(a)}function r(a,b){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm constructor');if(fa.has(a))throw new TypeError('internal error: bad object');fa.set(a,b)}function s(a){if(Object(a)!==a)throw new TypeError('bad object, not a Realm instance');if(!ga.has(a))throw new TypeError('bad object, use Realm.makeRootRealm() or .makeCompartment() instead of "new Realm"');return ga.get(a)}function t(a,b){if(Object(a)!==a)throw new TypeError('internal error: bad object, not a Realm instance');if(ga.has(a))throw new TypeError('internal error: Realm instance is already present');ga.set(a,b)}function u(a,b,c,d){G(b,a),H(b,'eval',{value:c,writable:!0,configurable:!0}),H(b,'Function',{value:d,writable:!0,configurable:!0})}function v(a){const{sharedGlobalDescs:b,unsafeGlobal:c}=a,d=F(c.Object.prototype),e=o(a,d),f=p(a,e);u(b,d,e,f);const g=I({safeGlobal:d,safeEval:e,safeFunction:f});return g}function w(a,b,c){c=Object(c);const d=c.shims||[],{allShims:e}=q(a),f=V(e,d),g=h(f),i=A(g);r(i,g);const j=v(g);t(b,j);for(const d of f)z(b,d)}function x(a,b){const c=q(a),d=v(c);t(b,d)}function y(a){const{safeGlobal:b}=s(a);return b}function z(a,b){const{safeEval:c}=s(a);return c(b)}function A(b){const c=a(b,{initRootRealm:w,initCompartment:x,getRealmGlobal:y,realmEvaluate:z});return b.sharedGlobalDescs.Realm={value:c,writable:!0,configurable:!0},c}const B=`'use strict'; (${function({initRootRealm:a,initCompartment:b,getRealmGlobal:c,realmEvaluate:d}){function e(a,...b){try{return a(...b)}catch(a){if(Object(a)!==a)throw a;let b,c,d;try{b=`${a.name}`,c=`${a.message}`,d=`${a.stack}`}catch(a){throw new Error('unknown error')}const e=g.get(b)||Error;try{throw new e(c)}catch(a){throw a.stack=d,a}}}const{defineProperty:f}=Object,g=new Map([['EvalError',EvalError],['RangeError',RangeError],['ReferenceError',ReferenceError],['SyntaxError',SyntaxError],['TypeError',TypeError],['URIError',URIError]]);class h{static makeRootRealm(...b){const c=new h;return e(a,h,c,...b),c}static makeCompartment(...a){const c=new h;return e(b,h,c,...a),c}get global(){return e(c,this)}evaluate(...a){return e(d,this,...a)}}return f(h.prototype,'toString',{value:()=>'function Realm() { [shim code] }',writable:!1,enumerable:!1,configurable:!0}),h}})`,C=['isFinite','isNaN','parseFloat','parseInt','decodeURI','decodeURIComponent','encodeURI','encodeURIComponent','Array','ArrayBuffer','Boolean','DataView','Date','Error','EvalError','Float32Array','Float64Array','Int8Array','Int16Array','Int32Array','Map','Number','Object','Promise','Proxy','RangeError','ReferenceError','RegExp','Set','String','Symbol','SyntaxError','TypeError','Uint8Array','Uint8ClampedArray','Uint16Array','Uint32Array','URIError','WeakMap','WeakSet','JSON','Math','Reflect','escape','unescape','Intl'],D=`(${c})();`,{assign:E,create:F,defineProperties:G,defineProperty:H,freeze:I,getOwnPropertyDescriptor:J,getOwnPropertyDescriptors:K,getOwnPropertyNames:L,getPrototypeOf:M,setPrototypeOf:N}=Object,{apply:O,ownKeys:P}=Reflect,Q=(a)=>(b,...c)=>O(a,b,c),R=Q(Array.prototype.forEach),S=Q(Array.prototype.push),T=Q(Array.prototype.pop),U=Q(Array.prototype.join),V=Q(Array.prototype.concat),W=Q(RegExp.prototype.match),X=Q(String.prototype.includes),Y='object'==typeof exports&&'undefined'!=typeof module,Z='object'==typeof document;if(!Y&&!Z||Y&&Z)throw new Error('unexpected platform, unable to create Realm');const $=Y?require('vm'):void 0,_='\'use strict\'; this',aa=`(0, eval)("'use strict'; this")`,ba=Y?function(){const a=$.runInNewContext(aa);return a}:function(){const a=document.createElement('iframe');a.style.display='none',document.body.appendChild(a);const b=a.contentWindow.eval(_);return b};class ca{constructor(a){this.unsafeGlobal=a.unsafeGlobal,this.unsafeEval=a.unsafeEval,this.useUnsafeEvaluator=!1}get(a,b){return'eval'===b?!0===this.useUnsafeEvaluator?(this.useUnsafeEvaluator=!1,this.unsafeEval):a.eval:b===Symbol.unscopables?void 0:b in a?a[b]:void 0}set(a,b,c){return M(a)[b]=c,!0}has(a,b){return'eval'===b||'arguments'!==b&&(!!(b in a)||!!(b in this.unsafeGlobal))}}const da=/^(.*)\bimport\s*(\(|\/\/|\/\*)/m,ea=/^[a-zA-Z_$][\w_$]*$/,fa=new WeakMap,ga=new WeakMap,ha=function(){const a=(0,eval)(_),b=f(a,[D]);return c(),b}(),ia=a(ha,{initRootRealm:w,initCompartment:x,getRealmGlobal:y,realmEvaluate:z});return r(ia,ha),ia});
//# sourceMappingURL=realm-shim.min.js.map
