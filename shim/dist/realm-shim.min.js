(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.Realm=b()})(this,function(){'use strict';function a(a,b){const{unsafeEval:c}=a;return c(x)(b)}function b(a){const b={Infinity:{value:Infinity},NaN:{value:NaN},undefined:{value:void 0}};for(const c of y)b[c]={value:a[c],writable:!0,configurable:!0};return b}function c(a){return'symbol'==typeof a?a:`${a}`}function d(a){const{unsafeGlobal:b}=a;B(b.Object.prototype,{__defineGetter__:{value(a,b){return C(this,a,{get:b,enumerable:!0,configurable:!0})}},__defineSetter__:{value(a,b){return C(this,a,{set:b,enumerable:!0,configurable:!0})}},__lookupGetter__:{value(a){a=c(a);let b,d=this;for(;d&&!(b=E(d,a));)d=H(d);return b&&b.get}},__lookupSetter__:{value(a){a=c(a);let b,d=this;for(;d&&!(b=E(d,a));)d=H(d);return b&&b.set}}})}function e(a,b,c){const{unsafeEval:d,unsafeFunction:e,unsafeGlobal:f}=a;let g;try{g=d(c)}catch(a){if(a instanceof f.SyntaxError)return;throw a}const h=H(g),i=e('throw new Error("Not available");');B(i,{name:{value:b},prototype:{value:h}}),C(h,'constructor',{value:i}),i!==e.prototype.constructor&&I(i,e.prototype.constructor)}function f(a){e(a,'Function','(function(){})'),e(a,'GeneratorFunction','(function*(){})'),e(a,'AsyncFunction','(async function(){})'),e(a,'AsyncGeneratorFunction','(async function*(){})')}function g(a){const c=b(a);return D({unsafeGlobal:a,sharedGlobalDescs:c,unsafeEval:a.eval,unsafeFunction:a.Function})}function h(a){d(a),f(a)}function i(){const a=Y(),b=g(a);return h(b),b}function j(a,b=void 0){const c=`please report internal shim error: ${a}`;console.log(c),b&&(console.log(`${b}`),console.log(`${b.stack}`));debugger;throw c}function k(a,b){a||j(`failed to: ${b}`)}function l(a){const b=[],c=F(a);for(const d of G(c)){const a=c[d];'string'!=typeof d||!R($,d)||!1!==a.configurable||!1!==a.writable||'get'in a||'set'in a||O(b,d)}return b}function m(a){return`const {${Q(a,',')}} = arguments[0];`}function n(a,b){const{unsafeFunction:c}=a,d=m(b);return c(`
    with (arguments[0]) {
      ${d}
      return function() {
        'use strict';
        return eval(arguments[0]);
      };
    }
  `)}function o(a,b){const{unsafeFunction:c}=a,d=new Z(a),e=A(b),f=new Proxy(e,d),g=l(b),h=n(a,g),i=h(f),m={eval(a){a=`${a}`,d.useUnsafeEvaluator=!0;let c;try{return J(i,b,[a])}catch(a){throw c=a,a}finally{!1!==d.useUnsafeEvaluator&&(d.useUnsafeEvaluator=!1,j('handler sets useUnsafeEvaluator = false',c))}}}.eval;return I(m,c.prototype),k(H(m).constructor!==Function,'hide Function'),k(H(m).constructor!==c,'hide unsafeFunction'),C(m,'toString',{value:m('() => \'function eval() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),m}function p(a,b){const{unsafeFunction:c,unsafeGlobal:d}=a,e=function(...a){const e=`${P(a)}`||'';let f=`${Q(a,',')}`;if(new c(e),S(f,')'))throw new d.SyntaxError('shim limitation: Function arg string contains parenthesis');0<f.length&&(f+='\n/*``*/');const g=`(function(${f}){\n${e}\n})`;return b(g)};return I(e,c.prototype),k(H(e).constructor!==Function,'hide Function'),k(H(e).constructor!==c,'hide unsafeFunction'),C(e,'prototype',{value:c.prototype}),C(e,'toString',{value:b('() => \'function Function() { [shim code] }\''),writable:!1,enumerable:!1,configurable:!0}),e}function q(a){if(Object(a)!==a)throw new TypeError;if(!_.has(a))throw new TypeError;return _.get(a)}function r(a,b){if(Object(a)!==a)throw new TypeError;if(_.has(a))throw new TypeError;_.set(a,b)}function s(a){if(Object(a)!==a)throw new TypeError;if(!aa.has(a))throw new TypeError;return aa.get(a)}function t(a,b){if(Object(a)!==a)throw new TypeError;if(aa.has(a))throw new TypeError;aa.set(a,b)}function u(a,b,c,d){B(b,a),C(b,'eval',{value:c,writable:!0,configurable:!0}),C(b,'Function',{value:d,writable:!0,configurable:!0})}function v(a){const{sharedGlobalDescs:b,unsafeGlobal:c}=a,d=A(c.Object.prototype),e=o(a,d),f=p(a,e);u(b,d,e,f);const g=D({safeGlobal:d,safeEval:e,safeFunction:f});return g}function w(b){const c=a(b,ba);return b.sharedGlobalDescs.Realm={value:c,writable:!0,configurable:!0},c}const x=`'use strict'; (${function(a){function b(a,b,...c){try{return e(a,b,c)}catch(a){if(Object(a)!==a)throw a;let b,c;try{b=`${a.name}`,c=`${a.message}`}catch(a){throw new Error('unknown error')}const d=g.get(b)||Error;throw new d(c)}}const{defineProperty:c,getOwnPropertyDescriptors:d}=Object,{apply:e,construct:f}=Reflect,g=new Map([['EvalError',EvalError],['RangeError',RangeError],['ReferenceError',ReferenceError],['SyntaxError',SyntaxError],['TypeError',TypeError],['URIError',URIError]]),h=d(a.prototype),i=h.global.get,j=h.evaluate.value;class k{constructor(...c){return b(f,void 0,a,c,k)}get global(){return b(i,this)}evaluate(...a){return b(j,this,a)}static makeRootRealm(){return new k}static makeCompartment(){return new k({transform:'inherit',isDirectEval:'inherit',intrinsics:'inherit'})}}return c(k.prototype,'toString',{value:()=>'function Realm() { [shim code] }',writable:!1,enumerable:!1,configurable:!0}),k}})`,y=['isFinite','isNaN','parseFloat','parseInt','decodeURI','decodeURIComponent','encodeURI','encodeURIComponent','Array','ArrayBuffer','Boolean','DataView','Date','Error','EvalError','Float32Array','Float64Array','Int8Array','Int16Array','Int32Array','Map','Number','Object','Promise','Proxy','RangeError','ReferenceError','RegExp','Set','String','Symbol','SyntaxError','TypeError','Uint8Array','Uint8ClampedArray','Uint16Array','Uint32Array','URIError','WeakMap','WeakSet','JSON','Math','Reflect','escape','unescape','Intl'],{assign:z,create:A,defineProperties:B,defineProperty:C,freeze:D,getOwnPropertyDescriptor:E,getOwnPropertyDescriptors:F,getOwnPropertyNames:G,getPrototypeOf:H,setPrototypeOf:I}=Object,{apply:J,ownKeys:K}=Reflect,L=Function.prototype.bind,M=L.bind(L.call),N=M(Object.prototype.hasOwnProperty),O=M(Array.prototype.push),P=M(Array.prototype.pop),Q=M(Array.prototype.join),R=M(RegExp.prototype.match),S=M(String.prototype.includes),T='object'==typeof exports&&'undefined'!=typeof module,U='object'==typeof document;if(!T&&!U||T&&U)throw new Error('unexpected platform, unable to create Realm');const V=T?require('vm'):void 0,W='\'use strict\'; this',X=`(0, eval)("'use strict'; this")`,Y=T?function(){const a=V.runInNewContext(X);return a}:function(){const a=document.createElement('iframe');a.style.display='none',document.body.appendChild(a);const b=a.contentWindow.eval(W);return b};class Z{constructor(a){this.unsafeGlobal=a.unsafeGlobal,this.unsafeEval=a.unsafeEval,this.useUnsafeEvaluator=!1}get(a,b){return'eval'===b?!0===this.useUnsafeEvaluator?(this.useUnsafeEvaluator=!1,this.unsafeEval):a.eval:b===Symbol.unscopables?void 0:b in a?a[b]:void 0}set(a,b,c){return H(a)[b]=c,!0}has(a,b){return'eval'===b||'arguments'!==b&&(!!(b in a)||!!(b in this.unsafeGlobal))}}const $=/^[a-zA-Z_$][\w_$]*$/,_=new WeakMap,aa=new WeakMap;class ba{constructor(a){a=Object(a);let b;if('inherit'===a.intrinsics&&'inherit'===a.isDirectEval&&'inherit'===a.transform)b=q(this.constructor);else if(void 0===a.intrinsics&&void 0===a.isDirectEval&&void 0===a.transform){b=i();const a=w(b);r(a,b)}else throw new TypeError('Realm only supports undefined or "inherited" intrinsics.');const c=v(b);t(this,c)}get global(){const{safeGlobal:a}=s(this);return a}evaluate(a){const{safeEval:b}=s(this);return b(a)}}const ca=function(){const a=(0,eval)(W),b=g(a);return h(b),b}(),da=a(ca,ba);return r(da,ca),da});
//# sourceMappingURL=realm-shim.min.js.map
