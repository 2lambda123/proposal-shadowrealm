{"version":3,"file":"realm-shim.min.js","sources":["../src/evaluators.js","../src/accessors.js","../src/functions.js","../src/sanitize.js","../src/sandbox.js","../src/stdlib.js","../src/intrinsics.js","../src/realm.js","../src/symbols.js","../src/commons.js","../src/handler.js"],"sourcesContent":["// Portions adapted from V8 - Copyright 2016 the V8 project authors.\n// https://github.com/v8/v8/blob/master/src/builtins/builtins-function.cc\n\nimport { GlobalObject, Intrinsics, ShimSandbox } from './symbols';\nimport { defineProperty, getOwnPropertyDescriptor, setPrototypeOf } from './commons';\nimport { Handler } from './handler';\n\nexport function getDirectEvalEvaluatorFactory(sandbox) {\n  const { unsafeFunction } = sandbox;\n\n  // Create a function in sloppy mode that returns\n  // a function in strict mode.\n  return unsafeFunction(`\n    with (arguments[0]) {\n      return function() {\n        'use strict';\n        return eval(arguments[0]);\n      };\n    }\n  `);\n}\n\nexport function getDirectEvalEvaluator(realmRec) {\n  const { [ShimSandbox]:sandbox, [GlobalObject]:globalObject, [Intrinsics]:intrinsics } = realmRec;\n\n  // This proxy has several functions:\n  // 1. works with the sentinel to alternate between direct eval and confined eval.\n  // 2. shadows all properties of the hidden global by declaring them as undefined.\n  // 3. resolves all existing properties of the sandboxed global.\n  const handler = new Handler(sandbox);\n  const proxy = new Proxy(globalObject, handler);\n\n  const scopedEvaluator = sandbox.evalEvaluatorFactory(proxy);\n\n  // Create an eval without a [[Construct]] behavior such that the\n  // invocation \"new eval()\" throws TypeError: eval is not a constructor\".\n  const evaluator = {\n    eval(src) {\n      handler.isInternalEvaluation = true;\n      // Ensure that \"this\" resolves to the secure global.\n      const result = scopedEvaluator.call(globalObject, src);\n      handler.isInternalEvaluation = false;\n      return result;\n    }\n  }.eval;\n\n  // Ensure that eval from any compartment in a root realm is an\n  // instance of Function in any compartment of the same root ralm.\n  const { unsafeFunction } = sandbox;\n  setPrototypeOf(evaluator, unsafeFunction.prototype.constructor);\n\n  // Once created for a realm, the reference must be updated everywhere.\n  return evaluator;\n}\n\n/**\n * A safe version of the native Function which relies on\n * the safety of evalEvaluator for confinement.\n */\nexport function getFunctionEvaluator(realmRec) {\n  const { [ShimSandbox]:sandbox, [GlobalObject]:globalObject, [Intrinsics]:intrinsics } = realmRec;\n\n  const evaluator = function Function(...params) {\n    const functionBody = params.pop() || '';\n    let functionParams = params.join(',');\n\n    if (functionParams.includes(')')) {\n      // If the formal parameters string include ) - an illegal\n      // character - it may make the combined function expression\n      // compile. We avoid this problem by checking for this early on.\n      throw new Error('Function arg string contains parenthesis');\n    }\n\n    if (functionParams.length > 0) {\n      // If the formal parameters include an unbalanced block comment, the\n      // function must be rejected. Since JavaScript does not allow nested\n      // comments we can include a trailing block comment to catch this.\n      functionParams += '\\n/*``*/';\n    }\n\n    const src = `(function(${functionParams}){\\n${functionBody}\\n})`;\n\n    return intrinsics.eval(src);\n  }\n\n  // Ensure that Function from any compartment in a root realm can be used\n  // with instance checks in any compartment of the same root realm.\n  const { unsafeFunction } = sandbox;\n  setPrototypeOf(evaluator, unsafeFunction.prototype.constructor);\n\n  // Ensure that any function created in any compartment in a root realm is an\n  // instance of Function in any compartment of the same root ralm.\n  const desc = getOwnPropertyDescriptor(evaluator, 'prototype');\n  desc.value = unsafeFunction.prototype\n  defineProperty(evaluator, 'prototype', desc);\n\n  // Once created for a realm, the reference must be everywhere.\n  return evaluator;\n}\n","// Adapted from SES/Caja - Copyright (C) 2011 Google Inc.\n// https://github.com/google/caja/blob/master/src/com/google/caja/ses/startSES.js\n// https://github.com/google/caja/blob/master/src/com/google/caja/ses/repairES5.js\n\nimport {\n  getPrototypeOf,\n  defineProperty,\n  defineProperties,\n  getOwnPropertyDescriptor\n} from './commons';\n\n/**\n * Replace the legacy accessors of Object to comply with strict mode\n * and ES2016 semantics, we do this by redefining them while in 'use strict'\n * https://tc39.github.io/ecma262/#sec-object.prototype.__defineGetter__\n */\nexport function repairAccessors(sandbox) {\n  const { unsafeGlobal: g } = sandbox;\n\n  defineProperties(g.Object.prototype, {\n    __defineGetter__: {\n      value(prop, func) {\n        return defineProperty(this, prop, {\n          get: func,\n          enumerable: true,\n          configurable: true\n        });\n      }\n    },\n    __defineSetter__: {\n      value(prop, func) {\n        return defineProperty(this, prop, {\n          set: func,\n          enumerable: true,\n          configurable: true\n        });\n      }\n    },\n    __lookupGetter__: {\n      value(prop) {\n        let base = this;\n        let desc;\n        while (base && !(desc = getOwnPropertyDescriptor(base, prop))) {\n          base = getPrototypeOf(base);\n        }\n        return desc && desc.get;\n      }\n    },\n    __lookupSetter__: {\n      value(prop) {\n        let base = this;\n        let desc;\n        while (base && !(desc = getOwnPropertyDescriptor(base, prop))) {\n          base = getPrototypeOf(base);\n        }\n        return desc && desc.set;\n      }\n    }\n  });\n}\n","// Adapted from SES/Caja\n// Copyright (C) 2011 Google Inc.\n// https://github.com/google/caja/blob/master/src/com/google/caja/ses/startSES.js\n// https://github.com/google/caja/blob/master/src/com/google/caja/ses/repairES5.js\n\nimport { defineProperty, defineProperties, getPrototypeOf, setPrototypeOf } from './commons';\n\n/**\n * The process to repair constructors:\n * 1. Obtain the prototype from an instance\n * 2. Create a substitute noop constructor\n * 3. Replace its prototype property with the original prototype\n * 4. Replace its prototype property's constructor with itself\n * 5. Replace its [[Prototype]] slot with the noop constructor of Function\n */\nfunction repairFunction(sandbox, functionName, functionDecl) {\n  const { unsafeEval, unsafeFunction } = sandbox;\n\n  const FunctionInstance = unsafeEval(`(${functionDecl}(){})`);\n  const FunctionPrototype = getPrototypeOf(FunctionInstance);\n\n  // Block evaluation of source when calling constructor on the prototype of functions.\n  const TamedFunction = unsafeFunction('throw new Error(\"Not available\");');\n\n  defineProperties(TamedFunction, {\n    name: {\n      value: functionName\n    },\n    prototype: {\n      value: FunctionPrototype\n    }\n  });\n  defineProperty(FunctionPrototype, 'constructor', { value: TamedFunction });\n\n  // Ensures that all functions meet \"instanceof Function\" in a realm.\n  setPrototypeOf(TamedFunction, unsafeFunction.prototype.constructor);\n}\n\n/**\n * This block replaces the original Function constructor, and the original\n * %GeneratorFunction% %AsyncFunction% and %AsyncGeneratorFunction%, with\n * safe replacements that preserve SES confinement. After this block is done,\n * the originals should no longer be reachable.\n */\nexport function repairFunctions(sandbox) {\n  const { unsafeGlobal: g } = sandbox;\n\n  // Here, the order of operation is important: Function needs to be\n  // repaired first since the other constructors need it.\n  repairFunction(sandbox, 'Function', 'function');\n  repairFunction(sandbox, 'GeneratorFunction', 'function*');\n  repairFunction(sandbox, 'AsyncFunction', 'async function');\n\n  const hasAsyncIteration = typeof g.Symbol.asyncIterator !== 'undefined';\n  if (hasAsyncIteration) {\n    repairFunction(sandbox, 'AsyncGeneratorFunction', 'async function*');\n  }\n}\n","import { repairAccessors } from './accessors';\nimport { repairFunctions } from './functions';\n\n// Sanitizing ensures that neither the legacy\n// accessors nor the function constructors can be\n// used to escape the confinement of the evaluators\n// to execute in the sandbox.\n\nexport function sanitize(sandbox) {\n  repairAccessors(sandbox);\n  repairFunctions(sandbox);\n}\n","import { getDirectEvalEvaluatorFactory } from './evaluators';\nimport { sanitize } from './sanitize';\n\n// The sandbox is shim-specific. It acts as the mechanism\n// to obtain a fresh set of intrinsics together with their\n// associated eval and Function evaluators. This association\n// must be respected since the evaluators are imposing a\n// set of intrinsics, aka the \"undeniables\".\n\nfunction createBrowserContext() {\n  const iframe = document.createElement('iframe');\n\n  iframe.title = 'script';\n  iframe.style.display = 'none';\n  iframe.setAttribute('aria-hidden', true);\n\n  document.body.appendChild(iframe);\n\n  return iframe.contentWindow;\n}\n\nexport function createSandbox(context) {\n  if (context === undefined) {\n    context = createBrowserContext();\n  }\n\n  // The sandbox is entirely defined by these three objects.\n  // Reusing the terminology from SES/Caja.\n  const sandbox = {\n    unsafeGlobal: context,\n    unsafeEval: context.eval,\n    unsafeFunction: context.Function\n  };\n\n  // Create the evaluator factory that will generate the evaluators\n  // for each compartment realm.\n  sandbox.evalEvaluatorFactory = getDirectEvalEvaluatorFactory(sandbox);\n\n  sanitize(sandbox);\n  return sandbox;\n}\n","export function getStdLib(intrinsics) {\n  const i = intrinsics;\n\n  return {\n    // *** 18.1 Value Properties of the Global Object\n\n    Infinity: { value: Infinity },\n    NaN: { value: NaN },\n    undefined: { value: undefined },\n\n    // *** 18.2 Function Properties of the Global Object\n\n    // Make eval wrtitable to allow proxy to return a different\n    // value, and leave it non-unconfigurable to prevent userland\n    // from changing its descriptor and breaking an invariant.\n    eval: { value: i.eval, writable: true },\n    isFinite: { value: i.isFinite },\n    isNaN: { value: i.isNaN },\n    parseFloat: { value: i.parseFloat },\n    parseInt: { value: i.parseInt },\n\n    decodeURI: { value: i.decodeURI },\n    decodeURIComponent: { value: i.decodeURIComponent },\n    encodeURI: { value: i.encodeURI },\n    encodeURIComponent: { value: i.encodeURIComponent },\n\n    // *** 18.3 Constructor Properties of the Global Object\n\n    Array: { value: i.Array },\n    ArrayBuffer: { value: i.ArrayBuffer },\n    Boolean: { value: i.Boolean },\n    DataView: { value: i.DataView },\n    Date: { value: i.Date },\n    Error: { value: i.Error },\n    EvalError: { value: i.EvalError },\n    Float32Array: { value: i.Float32Array },\n    Float64Array: { value: i.Float64Array },\n    Function: { value: i.Function },\n    Int8Array: { value: i.Int8Array },\n    Int16Array: { value: i.Int16Array },\n    Int32Array: { value: i.Int32Array },\n    Map: { value: i.Map },\n    Number: { value: i.Number },\n    Object: { value: i.Object },\n    Promise: { value: i.Promise },\n    Proxy: { value: i.Proxy },\n    RangeError: { value: i.RangeError },\n    ReferenceError: { value: i.ReferenceError },\n    RegExp: { value: i.RegExp },\n    Set: { value: i.Set },\n    // SharedArrayBuffer - Deprecated on Jan 5, 2018\n    String: { value: i.String },\n    Symbol: { value: i.Symbol },\n    SyntaxError: { value: i.SyntaxError },\n    TypeError: { value: i.TypeError },\n    Uint8Array: { value: i.Uint8Array },\n    Uint8ClampedArray: { value: i.Uint8ClampedArray },\n    Uint16Array: { value: i.Uint16Array },\n    Uint32Array: { value: i.Uint32Array },\n    URIError: { value: i.URIError },\n    WeakMap: { value: i.WeakMap },\n    WeakSet: { value: i.WeakSet },\n\n    // *** 18.4 Other Properties of the Global Object\n\n    Atomics: { value: i.Atomics },\n    JSON: { value: i.JSON },\n    Math: { value: i.Math },\n    Reflect: { value: i.Reflect },\n\n    // *** Annex B\n\n    escape: { value: i.escape },\n    unescape: { value: i.unescape },\n\n    // *** ECMA-402\n\n    Intl: { value: i.Intl },\n\n    // *** ESNext\n\n    Realm: { value: i.Realm }\n  };\n}\n","import { getPrototypeOf } from './commons';\n\n/**\n * Get the intrinsics from Table 7 & Annex B\n * Named intrinsics: available as data properties of the global object.\n * Anonymous intrinsics: not otherwise reachable by own property name traversal.\n *\n * https://tc39.github.io/ecma262/#table-7\n * https://tc39.github.io/ecma262/#table-73\n */\nexport function getIntrinsics(sandbox) {\n  const { unsafeGlobal: g } = sandbox;\n\n  // Anonymous intrinsics.\n\n  const SymbolIterator = g.Symbol.iterator;\n\n  const ArrayIteratorInstance = new g.Array()[SymbolIterator]();\n  const ArrayIteratorPrototype = getPrototypeOf(ArrayIteratorInstance);\n  const IteratorPrototype = getPrototypeOf(ArrayIteratorPrototype);\n\n  const AsyncFunctionInstance = g.eval('(async function(){})');\n  const AsyncFunction = AsyncFunctionInstance.constructor;\n  const AsyncFunctionPrototype = AsyncFunction.prototype;\n\n  const GeneratorFunctionInstance = g.eval('(function*(){})');\n  const GeneratorFunction = GeneratorFunctionInstance.constructor;\n  const Generator = GeneratorFunction.prototype;\n  const GeneratorPrototype = Generator.prototype;\n\n  const hasAsyncIterator = typeof g.Symbol.asyncIterator !== 'undefined';\n\n  const AsyncGeneratorFunctionInstance = hasAsyncIterator && g.eval('(async function*(){})');\n  const AsyncGeneratorFunction = hasAsyncIterator && AsyncGeneratorFunctionInstance.constructor;\n  const AsyncGenerator = hasAsyncIterator && AsyncGeneratorFunction.prototype;\n  const AsyncGeneratorPrototype = hasAsyncIterator && AsyncGenerator.prototype;\n\n  const AsyncIteratorPrototype = hasAsyncIterator && getPrototypeOf(AsyncGeneratorPrototype);\n  const AsyncFromSyncIteratorPrototype = undefined; // Not reacheable.\n\n  const MapIteratorObject = new g.Map()[SymbolIterator]();\n  const MapIteratorPrototype = getPrototypeOf(MapIteratorObject);\n\n  const SetIteratorObject = new g.Set()[SymbolIterator]();\n  const SetIteratorPrototype = getPrototypeOf(SetIteratorObject);\n\n  const StringIteratorObject = new g.String()[SymbolIterator]();\n  const StringIteratorPrototype = getPrototypeOf(StringIteratorObject);\n\n  const ThrowTypeError = g.eval(\n    '(function () { \"use strict\"; return Object.getOwnPropertyDescriptor(arguments, \"callee\").get; })()'\n  );\n\n  const TypedArray = getPrototypeOf(g.Int8Array);\n  const TypedArrayPrototype = TypedArray.prototype;\n\n  // Named intrinsics\n\n  const intrinsics = {\n    // *** Table 7\n\n    // %Array%\n    Array: g.Array,\n    // %ArrayBuffer%\n    ArrayBuffer: g.ArrayBuffer,\n    // %ArrayBufferPrototype%\n    ArrayBufferPrototype: g.ArrayBuffer.prototype,\n    // %ArrayIteratorPrototype%\n    ArrayIteratorPrototype,\n    // %ArrayPrototype%\n    ArrayPrototype: g.Array.prototype,\n    // %ArrayProto_entries%\n    ArrayProto_entries: g.Array.prototype.entries,\n    // %ArrayProto_foreach%\n    ArrayProto_foreach: g.Array.prototype.forEach,\n    // %ArrayProto_keys%\n    ArrayProto_keys: g.Array.prototype.forEach,\n    // %ArrayProto_values%\n    ArrayProto_values: g.Array.prototype.values,\n    // %AsyncFromSyncIteratorPrototype%\n    AsyncFromSyncIteratorPrototype,\n    // %AsyncFunction%\n    AsyncFunction,\n    // %AsyncFunctionPrototype%\n    AsyncFunctionPrototype,\n    // %AsyncGenerator%\n    AsyncGenerator,\n    // %AsyncGeneratorFunction%\n    AsyncGeneratorFunction,\n    // %AsyncGeneratorPrototype%\n    AsyncGeneratorPrototype,\n    // %AsyncIteratorPrototype%\n    AsyncIteratorPrototype,\n    // %Atomics%\n    Atomics: g.Atomics,\n    // %Boolean%\n    Boolean: g.Boolean,\n    // %BooleanPrototype%\n    BooleanPrototype: g.Boolean.prototype,\n    // %DataView%\n    DataView: g.DataView,\n    // %DataViewPrototype%\n    DataViewPrototype: g.DataView.prototype,\n    // %Date%\n    Date: g.Date,\n    // %DatePrototype%\n    DatePrototype: g.Date.prototype,\n    // %decodeURI%\n    decodeURI: g.decodeURI,\n    // %decodeURIComponent%\n    decodeURIComponent: g.decodeURIComponent,\n    // %encodeURI%\n    encodeURI: g.encodeURI,\n    // %encodeURIComponent%\n    encodeURIComponent: g.encodeURIComponent,\n    // %Error%\n    Error: g.Error,\n    // %ErrorPrototype%\n    ErrorPrototype: g.Error.prototype,\n    // %eval%\n    eval: g.eval,\n    // %EvalError%\n    EvalError: g.EvalError,\n    // %EvalErrorPrototype%\n    EvalErrorPrototype: g.EvalError.prototype,\n    // %Float32Array%\n    Float32Array: g.Float32Array,\n    // %Float32ArrayPrototype%\n    Float32ArrayPrototype: g.Float32Array.prototype,\n    // %Float64Array%\n    Float64Array: g.Float64Array,\n    // %Float64ArrayPrototype%\n    Float64ArrayPrototype: g.Float64Array.prototype,\n    // %Function%\n    Function: g.Function,\n    // %FunctionPrototype%\n    FunctionPrototype: g.Function.prototype,\n    // %Generator%\n    Generator,\n    // %GeneratorFunction%\n    GeneratorFunction,\n    // %GeneratorPrototype%\n    GeneratorPrototype,\n    // %Int8Array%\n    Int8Array: g.Int8Array,\n    // %Int8ArrayPrototype%\n    Int8ArrayPrototype: g.Int8Array.prototype,\n    // %Int16Array%\n    Int16Array: g.Int16Array,\n    // %Int16ArrayPrototype%,\n    Int16ArrayPrototype: g.Int16Array.prototype,\n    // %Int32Array%\n    Int32Array: g.Int32Array,\n    // %Int32ArrayPrototype%\n    Int32ArrayPrototype: g.Int32Array.prototype,\n    // %isFinite%\n    isFinite: g.isFinite,\n    // %isNaN%\n    isNaN: g.isNaN,\n    // %IteratorPrototype%\n    IteratorPrototype,\n    // %JSON%\n    JSON: g.JSON,\n    // %JSONParse%\n    JSONParse: g.JSON.parse,\n    // %Map%\n    Map: g.Map,\n    // %MapIteratorPrototype%\n    MapIteratorPrototype,\n    // %MapPrototype%\n    MapPrototype: g.Map.prototype,\n    // %Math%\n    Math: g.Math,\n    // %Number%\n    Number: g.Number,\n    // %NumberPrototype%\n    NumberPrototype: g.Number.prototype,\n    // %Object%\n    Object: g.Object,\n    // %ObjectPrototype%\n    ObjectPrototype: g.Object.prototype,\n    // %ObjProto_toString%\n    ObjProto_toString: g.Object.prototype.toString,\n    // %ObjProto_valueOf%\n    ObjProto_valueOf: g.Object.prototype.valueOf,\n    // %parseFloat%\n    parseFloat: g.parseFloat,\n    // %parseInt%\n    parseInt: g.parseInt,\n    // %Promise%\n    Promise: g.Promise,\n    // %Promise_all%\n    Promise_all: g.Promise.all,\n    // %Promise_reject%\n    Promise_reject: g.Promise.reject,\n    // %Promise_resolve%\n    Promise_resolve: g.Promise.resolve,\n    // %PromiseProto_then%\n    PromiseProto_then: g.Promise.prototype.then,\n    // %PromisePrototype%\n    PromisePrototype: g.Promise.prototype,\n    // %Proxy%\n    Proxy: g.Proxy,\n    // %RangeError%\n    RangeError: g.RangeError,\n    // %RangeErrorPrototype%\n    RangeErrorPrototype: g.RangeError.prototype,\n    // %ReferenceError%\n    ReferenceError: g.ReferenceError,\n    // %ReferenceErrorPrototype%\n    ReferenceErrorPrototype: g.ReferenceError.prototype,\n    // %Reflect%\n    Reflect: g.Reflect,\n    // %RegExp%\n    RegExp: g.RegExp,\n    // %RegExpPrototype%\n    RegExpPrototype: g.RegExp.prototype,\n    // %Set%\n    Set: g.Set,\n    // %SetIteratorPrototype%\n    SetIteratorPrototype,\n    // %SetPrototype%\n    SetPrototype: g.Set.prototype,\n    // %SharedArrayBuffer%\n    // SharedArrayBuffer - Deprecated on Jan 5, 2018\n    // %SharedArrayBufferPrototype%\n    // SharedArrayBufferPrototype - Deprecated on Jan 5, 2018\n    // %String%\n    String: g.String,\n    // %StringIteratorPrototype%\n    StringIteratorPrototype,\n    // %StringPrototype%\n    StringPrototype: g.String.prototype,\n    // %Symbol%\n    Symbol: g.Symbol,\n    // %SymbolPrototype%\n    SymbolPrototype: g.Symbol.prototype,\n    // %SyntaxError%\n    SyntaxError: g.SyntaxError,\n    // %SyntaxErrorPrototype%\n    SyntaxErrorPrototype: g.SyntaxError.prototype,\n    // %ThrowTypeError%\n    ThrowTypeError,\n    // %TypedArray%\n    TypedArray,\n    // %TypedArrayPrototype%\n    TypedArrayPrototype,\n    // %TypeError%\n    TypeError: g.TypeError,\n    // %TypeErrorPrototype%\n    TypeErrorPrototype: g.TypeError.prototype,\n    // %Uint8Array%\n    Uint8Array: g.Uint8Array,\n    // %Uint8ArrayPrototype%\n    Uint8ArrayPrototype: g.Uint8Array.prototype,\n    // %Uint8ClampedArray%\n    Uint8ClampedArray: g.Uint8ClampedArray,\n    // %Uint8ClampedArrayPrototype%\n    Uint8ClampedArrayPrototype: g.Uint8ClampedArray.prototype,\n    // %Uint16Array%\n    Uint16Array: g.Uint16Array,\n    // %Uint16ArrayPrototype%\n    Uint16ArrayPrototype: g.Uint16Array.prototype,\n    // %Uint32Array%\n    Uint32Array: g.Uint32Array,\n    // %Uint32ArrayPrototype%\n    Uint32ArrayPrototype: g.Uint32Array.prototype,\n    // %URIError%\n    URIError: g.URIError,\n    // %URIErrorPrototype%\n    URIErrorPrototype: g.URIError.prototype,\n    // %WeakMap%\n    WeakMap: g.WeakMap,\n    // %WeakMapPrototype%\n    WeakMapPrototype: g.WeakMap.prototype,\n    // %WeakSet%\n    WeakSet: g.WeakSet,\n    // %WeakSetPrototype%\n    WeakSetPrototype: g.WeakSet.prototype,\n\n    // *** Annex B\n\n    // %escape%\n    escape: g.escape,\n    // %unescape%\n    unescape: g.unescape,\n\n    // *** ECMA-402\n\n    Intl: g.Intl,\n\n    // *** ESNext\n    Realm: g.Realm\n  };\n\n  return intrinsics;\n}\n","import { createSandbox } from './sandbox';\nimport { getDirectEvalEvaluator, getFunctionEvaluator } from './evaluators';\nimport { getStdLib } from './stdlib';\nimport { getIntrinsics } from './intrinsics';\nimport { assert, IsCallable } from './utils';\nimport { assign, create, defineProperties } from './commons';\n\nimport {\n  RealmRecord,\n  Intrinsics,\n  GlobalObject,\n  DirectEvalEvaluator,\n  ShimSandbox\n} from './symbols';\n\nfunction getCurrentContext() {\n  // eslint-disable-next-line no-new-func\n  return new Function('return this')();\n}\n\nfunction getCurrentSandbox() {\n  const context = getCurrentContext()\n  const sandbox = createSandbox(context);\n  return sandbox;\n}\n\nfunction createRealmFacade(sandbox) {\n  const { unsafeFunction, unsafeGlobal } = sandbox;\n\n  // Rebuild a Realm class using inrinsics from the sandbox,\n  // to prevent the Realm parts from breaking identity\n  // continuity. This avoids loading the Ream shim in\n  // every root realm.\n\n  // This process is simplified becuase all methods\n  // and properties on a realm instance already return\n  // values based on the intrinsics of the realm.\n\n  unsafeGlobal.Realm = unsafeFunction('base', 'ShimSandbox', 'sandbox', `\n\nfunction Realm(options) {\n  this[ShimSandbox] = sandbox;\n  base.call(this, options);\n}\n\nconst descs = Object.getOwnPropertyDescriptors(base.prototype);\n\nObject.defineProperties(Realm.prototype, {\n  intrinsics: {\n    get() {\n      return descs.intrinsics.get.call(this);\n    }\n  },\n  global: {\n    get() {\n      return descs.global.get.call(this);\n    }\n  },\n  evaluate: {\n    value(x) {\n      return descs.evaluate.value.call(this, x);\n    }\n  }\n});\n\nRealm.toString = () => base.toString();\n\nreturn Realm;\n\n  `)(Realm, ShimSandbox, sandbox);\n\n}\n\nfunction setGlobaObject(realmRec) {\n  const intrinsics = realmRec[Intrinsics];\n  const globalObj = create(intrinsics.ObjectPrototype);\n  globalObj[RealmRecord] = realmRec;\n  realmRec[GlobalObject] = globalObj;\n}\n\nfunction createEvaluators(realmRec) {\n\n  // Divergence from specifications: the evaluators are tied to\n  // a global and they are tied to a realm and to the intrinsics\n  // of that realm.\n  const directEvalEvaluator = getDirectEvalEvaluator(realmRec);\n  const FunctionEvaluator = getFunctionEvaluator(realmRec);\n\n  // No need to store Function.\n  realmRec[DirectEvalEvaluator] = directEvalEvaluator;\n\n  // Limitation: export a direct evaluator.\n  const intrinsics = realmRec[Intrinsics];\n  intrinsics.eval = directEvalEvaluator;\n  intrinsics.Function = FunctionEvaluator;\n}\n\nfunction setDefaultBindings(realmRec) {\n  const intrinsics = realmRec[Intrinsics]\n  const descs = getStdLib(intrinsics);\n  defineProperties(realmRec[GlobalObject], descs);\n}\n\n// The current sandbox is the sandbox where the\n// Realm shim is being parsed and executed.\nconst currentSandbox = getCurrentSandbox();\n\nexport default function Realm(options) {\n  const O = this;\n  const opts = Object(options);\n\n  let sandbox;\n  let intrinsics = opts.intrinsics;\n  if (intrinsics === 'inherit') {\n    // In \"inherit\" mode, we create a compartment realm and inherit\n    // the sandbox since we share the intrinsics. We create a new\n    // set to allow us to define eval() anf Function() for the realm.\n    if (ShimSandbox in O) {\n      sandbox = O[ShimSandbox]\n    } else {\n      sandbox = currentSandbox;\n    }\n\n  } else if (intrinsics === undefined) {\n    // When intrinics are not provided, we create a root realm\n    // using the fresh set of new intrinics from a new sandbox.\n    sandbox = createSandbox();\n    createRealmFacade(sandbox);\n\n  } else {\n    throw new TypeError('Realm only supports undefined or \"inherited\" intrinsics.');\n  }\n  intrinsics = getIntrinsics(sandbox);\n\n  const realmRec = {\n    [ShimSandbox]: sandbox,\n    [Intrinsics]: intrinsics,\n    [GlobalObject]: undefined,\n    [DirectEvalEvaluator]: undefined\n  };\n\n  setGlobaObject(realmRec);\n  createEvaluators(realmRec);\n  setDefaultBindings(realmRec);\n\n  O[RealmRecord] = realmRec;\n}\n\ndefineProperties(Realm.prototype, {\n  intrinsics: {\n    get() {\n      const O = this;\n      if (typeof O !== 'object') throw new TypeError();\n      if (!(RealmRecord in O)) throw new TypeError();\n      const intrinsics = O[RealmRecord][Intrinsics];\n      // The object returned has its prototype\n      // match the ObjectPrototype of the realm.\n      const obj = create(intrinsics.ObjectPrototype);\n      return assign(obj, intrinsics);\n    }\n  },\n  global: {\n    get() {\n      const O = this;\n      if (typeof O !== 'object') throw new TypeError();\n      if (!(RealmRecord in O)) throw new TypeError();\n      return O[RealmRecord][GlobalObject];\n    }\n  },\n  evaluate: {\n    value(x) {\n      const O = this;\n      if (typeof O !== 'object') throw new TypeError();\n      if (!(RealmRecord in O)) throw new TypeError();\n      const realmRec = O[RealmRecord];\n      const evaluator = realmRec[DirectEvalEvaluator]\n      return evaluator(x);\n    }\n  }\n});\n\nRealm.toString = () => 'function Realm() { [shim code] }';\n","export const RealmRecord = Symbol('Realm Slot');\nexport const Intrinsics = Symbol('Intrinsics Slot');\nexport const GlobalObject = Symbol('GlobalObject Slot');\nexport const DirectEvalEvaluator = Symbol('DirectEvalEvaluator Slot');\nexport const ShimSandbox = Symbol('Shim Sandbox');\n","// Declare shorthand functions. Sharing these declarations accross modules\n// improves both consitency and minification. Unused declarations are dropped\n// by the tree shaking process.\n\nexport const {\n  assign,\n  create,\n  defineProperties,\n  freeze,\n  getOwnPropertyDescriptors,\n  getOwnPropertyNames\n} = Object;\n\nexport const {\n  apply,\n  defineProperty,\n  deleteProperty,\n  getOwnPropertyDescriptor,\n  getPrototypeOf,\n  ownKeys,\n  setPrototypeOf\n} = Reflect;\n\nexport const objectHasOwnProperty = Object.prototype.hasOwnProperty;\n","export class Handler {\n  // Properties stored on the handler\n  // are not available from the proxy.\n\n  constructor(sandbox) {\n    const { unsafeGlobal } = sandbox;\n    this.unsafeGlobal = unsafeGlobal;\n\n    // this flag allow us to determine if the eval() call is a controlled\n    // eval done by the realm's code or if it is user-land invocation, so\n    // we can react differently.\n    this.isInternalEvaluation = false;\n  }\n\n  get(target, prop) {\n    // Special treatment for eval.\n    if (prop === 'eval') {\n      if (this.isInternalEvaluation) {\n        this.isInternalEvaluation = false;\n        return this.unsafeGlobal.eval;\n      }\n      return target.eval;\n    }\n    // Properties of the global.\n    if (prop in target) {\n      return target[prop];\n    }\n    // Prevent the lookup for other properties.\n    return undefined;\n  }\n\n  has(target, prop) {\n    if (prop === 'eval') {\n      return true;\n    }\n    if (prop === 'arguments') {\n      return false;\n    }\n    if (prop in target) {\n      return true;\n    }\n    if (prop in this.unsafeGlobal) {\n      return true;\n    }\n    return false;\n  }\n}\n"],"names":["unsafeFunction","Proxy","evalEvaluatorFactory","eval","isInternalEvaluation","call","prototype","constructor","pop","join","includes","Error","length","value","unsafeGlobal","Object","__defineGetter__","get","enumerable","configurable","__defineSetter__","set","__lookupGetter__","__lookupSetter__","unsafeEval","name","Symbol","asyncIterator","document","createElement","title","style","display","setAttribute","body","appendChild","contentWindow","Function","Infinity","NaN","undefined","writable","isFinite","isNaN","parseFloat","parseInt","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Array","ArrayBuffer","Boolean","DataView","Date","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Map","Number","Promise","RangeError","ReferenceError","RegExp","Set","String","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","Atomics","JSON","Math","Reflect","escape","unescape","Intl","Realm","iterator","ArrayBufferPrototype","ArrayIteratorPrototype","ArrayPrototype","ArrayProto_entries","entries","ArrayProto_foreach","forEach","ArrayProto_keys","ArrayProto_values","values","AsyncFromSyncIteratorPrototype","AsyncFunction","AsyncFunctionPrototype","AsyncGenerator","AsyncGeneratorFunction","AsyncGeneratorPrototype","AsyncIteratorPrototype","BooleanPrototype","DataViewPrototype","DatePrototype","ErrorPrototype","EvalErrorPrototype","Float32ArrayPrototype","Float64ArrayPrototype","FunctionPrototype","Generator","GeneratorFunction","GeneratorPrototype","Int8ArrayPrototype","Int16ArrayPrototype","Int32ArrayPrototype","IteratorPrototype","JSONParse","parse","MapIteratorPrototype","MapPrototype","NumberPrototype","ObjectPrototype","ObjProto_toString","toString","ObjProto_valueOf","valueOf","Promise_all","all","Promise_reject","reject","Promise_resolve","resolve","PromiseProto_then","then","PromisePrototype","RangeErrorPrototype","ReferenceErrorPrototype","RegExpPrototype","SetIteratorPrototype","SetPrototype","StringIteratorPrototype","StringPrototype","SymbolPrototype","SyntaxErrorPrototype","ThrowTypeError","TypedArray","TypedArrayPrototype","TypeErrorPrototype","Uint8ArrayPrototype","Uint8ClampedArrayPrototype","Uint16ArrayPrototype","Uint32ArrayPrototype","URIErrorPrototype","WeakMapPrototype","WeakSetPrototype","intrinsics","assign","create","defineProperties","freeze","getOwnPropertyDescriptors","getOwnPropertyNames","apply","defineProperty","deleteProperty","getOwnPropertyDescriptor","getPrototypeOf","ownKeys","setPrototypeOf","has","global","evaluate"],"mappings":"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"}