<html>
    <header>
        <script src="../dist/realm-shim.js"></script>
    </header>
    <body>
        <h1>Realm Shim</h1>
        <p>
            This demo show allow you to evaluate code inside a brand new Realm:
        </p>

        Input:<br />
        <textarea id="sourceText" rows="20" style="width: 50%;">

        </textarea><br />
        <button id="run">Evaluate</button><br />
        Output:<br />
        <textarea id="output" disabled="disabled" rows="20" style="width: 50%;">

        </textarea>

        <p>
            <small>Note: you can look in the console to inspect the original output of the evaluation.</small>
        </p>

        <script>

        // basic sanity check: they all should output true

        // Root realm
        const r1 = new Realm();

        console.log(1.1, r1.eval('( JSON )'));
        console.log(1.2, r1.eval('( JSON )') !== JSON);
        console.log(1.3, r1.eval('( JSON )') === r1.eval('( JSON )'));
        console.log(1.4, r1.eval('( JSON )') === r1.eval('( eval("JSON") )'));
        console.log(1.5, r1.eval('( eval instanceof Function )'));

        // Root realm vs root realm
        const r2 = new Realm();

        console.log(2.1, r2.eval('( JSON )'));
        console.log(2.2, r2.eval('( JSON )') !== JSON);
        console.log(2.3, r2.eval('( JSON )') === r2.eval('( JSON )'));
        console.log(2.4, r2.eval('( JSON )') === r2.eval('( eval("JSON") )'));
        console.log(2.5, r2.eval('( eval instanceof Function )'));

        console.log(2.6, r2.eval('( JSON )') !== r1.eval('( JSON )'));
        console.log(2.7, r2.eval('( eval("JSON") )') !== r1.eval('( eval("JSON") )'));

        // Compartment realm vs root realm
        const r3 = new r1.global.Realm({ intrinsics: 'inherit' });

        console.log(3.1, r3.eval('( JSON )'));
        console.log(3.2, r3.eval('( JSON )') !== JSON);
        console.log(3.3, r3.eval('( JSON )') === r3.eval('( JSON )'));
        console.log(3.4, r3.eval('( JSON )') === r3.eval('( eval("JSON") )'));
        console.log(3.5, r1.eval('( eval instanceof Function )'));

        console.log(3.6, r3.eval('( JSON )') === r1.eval('( JSON )'));
        console.log(3.7, r3.eval('( eval("JSON") )') === r1.eval('( eval("JSON") )'));

        const r = new Realm();
        document.getElementById('run').addEventListener('click', function () {
            const sourceText = document.getElementById('sourceText').value;
            let result, output;
            try {
                result = r.eval(sourceText);
            } catch (e) {
                result = 'Error: ' + e;
            }
            try {
                output = typeof result === 'function' ? result.toString() : JSON.stringify(result);
            } catch (e) {
                output = 'Error trying to serialize the result: ' + e;
                output += '\nOriginal Object: ' + result;
            }

            console.log(result);
            document.getElementById('output').value = output;
        });
        </script>
    </body>
</html>